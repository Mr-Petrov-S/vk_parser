# Добро пожаловать!

Этот скрипт написан для выгрузки участников группы vk, сохранения их в файл data.csv и последующей загрузки на локальный контейнер clickhouse в docker. В текущей версии настроен на группу vk_fishing.

**Получаемые данные:** 
    user_id/Имя/Фамилия/Дата рождения/Время последнего визита/Город/Контакты/Кол-во друзей

**Для корректной работы требуется валидный токен (сервисный ключ) vk. Ниже будет инструкция для его получения.** 
В зависимости от размеров группы, может потребоваться разное время на получение данных. Работа реализована на двух методах: groups.GetMembers и friends.Get. В текущей версии API, через groups.GetMembers нельзя получить количество друзей, поэтому используется friends.Get. 
Время работы на примере группы vk_fishing (850+ тысяч участников, по состоянию на 06.2024): 
- groups.GetMembers на одном токене отрабатывает примерно за 25 - 30 минут
- friends.Get при использовании 10 токенов отрабатывает за 20-25 минут


## Описание работы:

- После начала работы запускается функция получения токена из .env файла. Адрес для расположения файла: 'config/.env', пример содержимого файла добавлен в репозиторий. Получение токена реализовано в двух видах: один токен для работы groups.GetMembers и список токенов для работы friends.Get. Количество токенов для friends.Get напрямую влияет на скорость выполнения. VERSION - переменная с актуальной версией api vk. GROUP_ID - группа к которой будут осуществлятся запросы, DATABASE_NAME - название базы данных которая будет создана в clickhouse.

- Далее запускается функция отрабатывающая метод groups.GetMembers, по итогам получаем json и сохраняем его в датафрейм.Так как скачивание может быть не бытрым процессом, срипт оснащен прогресс баром для отслеживания, в случае ошибки будет выдано соответствующее описание. 

- После сохранения мы получаем список пользователей для которых будем получать количество друзей. На этом этапе отсекаем тех у кого закрыта страница, по ним информацию о друзьях получить нельзя.

- Полученный список передаем в функцию, которая делит пользователей на группы и с помощью метода execute передает по 25 пользователей в одном запросе, кроме этого запускается количество параллельных потоков с запросами, равный количеству переданных токенов. Результат сохраняем в датафрейм и объеденям по id c данными полученными на прошлом шаге. Полученный объединенный датафрейм сохраняется в 'data/data.csv'.
 
- Далее создается и запускается локальный docker контейнер clickhouse, с названием 'clickhouse-server'. Инициализируется клиент для запросов с помощью clickhouse-driver. Создается база данных с ранее заданным названием и в нее загружаются данные которые мы получили от vk. После окончания загрузки, контейнер останавливается и работа программы прекращается. 
- В файле eda.ipynb представлен небольшой исследовательский анализ данных, по полученным данным.

## Краткое описание файлов:
main.py - главный исполнительный файл
func.py - файл содержащий все функции данного скрипта
eda.ipynb - исследователский анализ полученых данных
env.example - пример .env файла необходимого для работы
requirements.txt - список зависимостей для установки библиотек окружения


### Ниже описаны шаги для получения токена для запросов к API vk.com

Для получения токена необходимо:
1. Зайти на сайт https://dev.vk.com/
2. Авторизоваться на сайте под своим аккаунтом vk
3. Перейти на вкладку приложения -> Создать приложение
4. На странице создания приложения выбираем тип приложения -> Мини-приложение, и создаем приложение. Категория не критична. Потребуется подтверждение по смс или звонку. 
5. Нас переместит на страницу настроек приложения, в меню с левой стороны, выбираем: Разработка -> Ключи доступа -> Сервисный ключ -> Показать (потребуется подтверждение по звонку или смс).
6. После выполнения всех этих манипуляций, будет показан сервисный ключ(токен), который можно использовать для запросов к api vk. Если требуется несколько токенов - создаем несколько приложений аналогичным образом. 

Также непосредственно на сайте https://dev.vk.com/ в разделе API, можно протестировать работу некоторых методов API, путем ввода данных в веб-форму.(требуется токен)


